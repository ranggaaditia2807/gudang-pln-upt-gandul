<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Transaksi - Gudang UPT Gandul</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="header">
        <div class="logo">Gudang UPT Gandul</div>
        <nav class="nav-links">
            <a href="index.html">Home</a>
            <a href="dasboard.html">Dashboard</a>
            <a href="manajemen-gudang.html">Manajemen Gudang</a>
            <a href="transaksi.html">Transaksi</a>
        </nav>
    </div>

    <div class="dashboard-content">
        <h1 style="text-align:center; margin-bottom:30px; color:#005baa;">
            <i class="fas fa-chart-line"></i> Laporan Transaksi
        </h1>

        <!-- Filter Section -->
        <div id="form-container">
            <h2 style="text-align:center; margin-bottom:20px;">Filter Laporan</h2>
            <form id="filterForm">
                <div>
                    <label for="jenisTransaksi">Jenis Transaksi</label>
                    <select id="jenisTransaksi">
                        <option value="semua">Semua Transaksi</option>
                        <option value="pemasukan">Pemasukan</option>
                        <option value="pengeluaran">Pengeluaran</option>
                    </select>
                </div>
                
                <div>
                    <label for="tanggalMulai">Tanggal Mulai</label>
                    <input type="date" id="tanggalMulai">
                </div>
                
                <div>
                    <label for="tanggalAkhir">Tanggal Akhir</label>
                    <input type="date" id="tanggalAkhir">
                </div>
                
                <div>
                    <label for="supplierTujuan">Supplier/Tujuan</label>
                    <input type="text" id="supplierTujuan" placeholder="Masukkan nama supplier atau tujuan">
                </div>
                
                <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
                    <button type="button" onclick="generateLaporan()">
                        <i class="fas fa-search"></i> Generate Laporan
                    </button>
                    <button type="button" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i> Export Excel
                    </button>
                    <button type="button" onclick="printLaporan()">
                        <i class="fas fa-print"></i> Cetak
                    </button>
                </div>
            </form>
        </div>                           

        <!-- Summary Cards -->
        <div class="stats-container">
            <div class="stat-card">
                <h2 id="totalTransaksi">0</h2>
                <p>Total Transaksi</p>
            </div>
            <div class="stat-card">
                <h2 id="totalPemasukan">0</h2>
                <p>Total Pemasukan</p>
            </div>
            <div class="stat-card">
                <h2 id="totalPengeluaran">0</h2>
                <p>Total Item Keluar</p>
            </div>
        </div>

        <!-- Data Table -->
        <div style="margin-bottom:24px; text-align:center;">
            <h3 style="color:#005baa; margin-bottom:15px;">Data Transaksi</h3>
            <div style="overflow-x:auto;">
                <table id="persediaan-table" style="width:100%;">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>No. Transaksi</th>
                            <th>Tanggal</th>
                            <th>Jenis</th>
                            <th>Supplier/Tujuan</th>
                            <th>Jumlah Item</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyLaporan">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="../shared/data-integration.js"></script>
    <script>
        // Inisialisasi
        document.addEventListener('DOMContentLoaded', function() {
            // Set tanggal hari ini
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tanggalAkhir').value = today;
            
            // Set tanggal awal bulan ini
            const firstDay = new Date();
            firstDay.setDate(1);
            document.getElementById('tanggalMulai').value = firstDay.toISOString().split('T')[0];
            
            // Isi dropdown supplier/tujuan
            loadSuppliersAndTujuan();
            
            // Generate laporan awal
            generateLaporan();
        });

        function loadSuppliersAndTujuan() {
            const transaksiPemasukan = JSON.parse(localStorage.getItem('transaksiPemasukan')) || [];
            const transaksiPengeluaran = JSON.parse(localStorage.getItem('transaksiPengeluaran')) || [];
            
            const suppliers = [...new Set(transaksiPemasukan.map(t => t.supplier))];
            const tujuans = [...new Set(transaksiPengeluaran.map(t => t.tujuan))];
            
            const select = document.getElementById('supplierTujuan');
            [...suppliers, ...tujuans].forEach(item => {
                if (item) {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    select.appendChild(option);
                }
            });
        }

        function generateLaporan() {
            const jenisTransaksi = document.getElementById('jenisTransaksi').value;
            const tanggalMulai = document.getElementById('tanggalMulai').value;
            const tanggalAkhir = document.getElementById('tanggalAkhir').value;
            const supplierTujuan = document.getElementById('supplierTujuan').value;
            
            // Ambil data dari localStorage
            const transaksiPemasukan = JSON.parse(localStorage.getItem('transaksiPemasukan')) || [];
            const transaksiPengeluaran = JSON.parse(localStorage.getItem('transaksiPengeluaran')) || [];
            
            let allTransaksi = [];
            
            // Filter berdasarkan jenis transaksi
            if (jenisTransaksi === 'semua' || jenisTransaksi === 'pemasukan') {
                allTransaksi = allTransaksi.concat(transaksiPemasukan.map(t => ({...t, jenis: 'Pemasukan'})));
            }
            
            if (jenisTransaksi === 'semua' || jenisTransaksi === 'pengeluaran') {
                allTransaksi = allTransaksi.concat(transaksiPengeluaran.map(t => ({...t, jenis: 'Pengeluaran'})));
            }
            
            // Filter berdasarkan tanggal
            if (tanggalMulai && tanggalAkhir) {
                allTransaksi = allTransaksi.filter(t => {
                    const tanggal = new Date(t.tanggalMasuk || t.tanggalKeluar);
                    return tanggal >= new Date(tanggalMulai) && tanggal <= new Date(tanggalAkhir);
                });
            }
            
            // Filter berdasarkan supplier/tujuan
            if (supplierTujuan && supplierTujuan !== '') {
                allTransaksi = allTransaksi.filter(t => 
                    (t.supplier === supplierTujuan) || (t.tujuan === supplierTujuan)
                );
            }
            
            // Tampilkan data
            tampilkanData(allTransaksi);
            updateRingkasan(allTransaksi);
        }

        function tampilkanData(transaksi) {
            const tbody = document.getElementById('tbodyLaporan');
            tbody.innerHTML = '';
            
            transaksi.forEach((t, index) => {
                const row = tbody.insertRow();
                
                // Hitung total item berdasarkan jumlah barang
                let totalItem = 0;
                
                if (t.barang && Array.isArray(t.barang)) {
                    if (t.jenis === 'Pemasukan') {
                        // Untuk pemasukan, hitung total jumlah barang
                        totalItem = t.barang.reduce((sum, b) => sum + (parseInt(b.jumlah) || 0), 0);
                    } else {
                        // Untuk pengeluaran, hitung jumlah item yang dikeluarkan
                        totalItem = t.barang.reduce((sum, b) => sum + (parseInt(b.jumlahKeluar) || 0), 0);
                    }
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${t.noTransaksi || t.noTransaksiKeluar}</td>
                    <td>${t.tanggalMasuk || t.tanggalKeluar}</td>
                    <td><span class="${t.jenis === 'Pemasukan' ? 'status-masuk' : 'status-keluar'}">${t.jenis}</span></td>
                    <td>${t.supplier || t.tujuan}</td>
                    <td>${totalItem}</td>
                    <td>
                        <button onclick="lihatDetail('${t.noTransaksi || t.noTransaksiKeluar}', '${t.jenis}')">Detail</button>
                    </td>
                `;
            });
        }

        function updateRingkasan(transaksi) {
            const totalTransaksi = transaksi.length;
            const totalPemasukan = transaksi.filter(t => t.jenis === 'Pemasukan')
                .reduce((sum, t) => sum + t.barang.reduce((s, b) => s + (parseInt(b.jumlah) || 0), 0), 0);
            const totalPengeluaran = transaksi.filter(t => t.jenis === 'Pengeluaran')
                .reduce((sum, t) => sum + t.barang.reduce((s, b) => s + (parseInt(b.jumlahKeluar) || 0), 0), 0);
            
            document.getElementById('totalTransaksi').textContent = totalTransaksi;
            document.getElementById('totalPemasukan').textContent = totalPemasukan;
            document.getElementById('totalPengeluaran').textContent = totalPengeluaran;
        }

        function lihatDetail(noTransaksi, jenis) {
            const transaksiPemasukan = JSON.parse(localStorage.getItem('transaksiPemasukan')) || [];
            const transaksiPengeluaran = JSON.parse(localStorage.getItem('transaksiPengeluaran')) || [];
            
            let transaksi;
            if (jenis === 'Pemasukan') {
                transaksi = transaksiPemasukan.find(t => t.noTransaksi === noTransaksi);
            } else {
                transaksi = transaksiPengeluaran.find(t => t.noTransaksiKeluar === noTransaksi);
            }
            
            // Tambahkan pemeriksaan untuk memastikan transaksi ditemukan
            if (transaksi) {
                let detail = `Detail Transaksi ${jenis}\n\n`;
                detail += `No. Transaksi: ${transaksi.noTransaksi || transaksi.noTransaksiKeluar}\n`;
                detail += `Tanggal: ${transaksi.tanggalMasuk || transaksi.tanggalKeluar || 'Tidak ada tanggal'}\n`;
                detail += `${jenis === 'Pemasukan' ? 'Supplier' : 'Tujuan'}: ${transaksi.supplier || transaksi.tujuan || 'Tidak ada informasi'}\n`;
                detail += `Keterangan: ${transaksi.keterangan || transaksi.keteranganKeluar || 'Tidak ada keterangan'}\n\n`;
                detail += 'Detail Barang:\n';
                
                // Menambahkan detail barang
                if (transaksi.barang && Array.isArray(transaksi.barang)) {
                    transaksi.barang.forEach(b => {
                        detail += `- Kode: ${b.kodeBarang || 'Tidak ada kode'}, Nama: ${b.namaBarang || 'Tidak ada nama'}, Jumlah: ${b.jumlah || b.jumlahKeluar || 'Tidak ada jumlah'}\n`;
                    });
                } else {
                    detail += 'Tidak ada detail barang.\n';
                }

                alert(detail);
            } else {
                alert('Transaksi tidak ditemukan.');
            }
        }

        function exportToExcel() {
            const table = document.getElementById('persediaan-table');
            let csv = [];
            
            // Header
            const headers = Array.from(table.querySelectorAll('th')).map(th => th.textContent);
            csv.push(headers.join(','));
            
            // Data
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const rowData = Array.from(row.querySelectorAll('td')).map(td => {
                    let text = td.textContent;
                    return `"${text}"`;
                });
                csv.push(rowData.join(','));
            });
            
            const csvContent = csv.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'laporan-transaksi.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function printLaporan() {
            window.print();
        }
    </script>
</body>
</html>

