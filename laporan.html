<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Transaksi - Gudang PLN UPT Gandul</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <header>
        <h1>Laporan Transaksi Gudang PLN UPT Gandul</h1>
    </header>

    <main>
        <section class="ringkasan">
            <h2>Ringkasan</h2>
            <div class="stats">
                <div class="stat">
                    <i class="fas fa-exchange-alt"></i>
                    <p>Total Transaksi</p>
                    <h3 id="totalTransaksi">0</h3>
                </div>
                <div class="stat">
                    <i class="fas fa-arrow-down"></i>
                    <p>Total Pemasukan</p>
                    <h3 id="totalPemasukan">0</h3>
                </div>
                <div class="stat">
                    <i class="fas fa-arrow-up"></i>
                    <p>Total Pengeluaran</p>
                    <h3 id="totalPengeluaran">0</h3>
                </div>
            </div>
        </section>

        <section class="tabel">
            <h2>Detail Transaksi</h2>
            <table id="tabelLaporan">
                <thead>
                    <tr>
                        <th>Tanggal</th>
                        <th>Jenis</th>
                        <th>Kode Barang</th>
                        <th>Nama Barang</th>
                        <th>Jumlah</th>
                        <th>Satuan</th>
                        <th>Lokasi</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data transaksi akan ditampilkan di sini -->
                </tbody>
            </table>
        </section>
    </main>

    <script>
    // ===== Konfigurasi Data Terpusat =====
    const DATA_CONFIG = {
        STORAGE_KEYS: {
            BARANG: 'barang',
            TRANSAKSI_PEMASUKAN: 'transaksiPemasukan',
            TRANSAKSI_PENGELUARAN: 'transaksiPengeluaran',
            LAPORAN: 'laporan'
        },
        
        DEFAULT_BARANG: [
            { kode: 'BRG001', nama: 'Laptop Dell', stok: 10, satuan: 'unit', lokasi: 'Rak A1' },
            { kode: 'BRG002', nama: 'Mouse Wireless', stok: 5, satuan: 'pcs', lokasi: 'Rak B2' },
            { kode: 'BRG003', nama: 'Keyboard Mechanical', stok: 2, satuan: 'pcs', lokasi: 'Rak B3' }
        ],
        
        getDataBarang: function() {
            return JSON.parse(localStorage.getItem(this.STORAGE_KEYS.BARANG)) || [];
        },
        
        saveDataBarang: function(barang) {
            localStorage.setItem(this.STORAGE_KEYS.BARANG, JSON.stringify(barang));
        },
        
        initData: function() {
            if (!localStorage.getItem(this.STORAGE_KEYS.BARANG)) {
                this.saveDataBarang(this.DEFAULT_BARANG);
                console.log("Data barang diinisialisasi dengan data default");
            }
        },
        
        sinkronisasiStok: function() {
            const barang = this.getDataBarang();
            const transaksiPemasukan = JSON.parse(localStorage.getItem(this.STORAGE_KEYS.TRANSAKSI_PEMASUKAN)) || [];
            const transaksiPengeluaran = JSON.parse(localStorage.getItem(this.STORAGE_KEYS.TRANSAKSI_PENGELUARAN)) || [];
            
            console.log("Memulai sinkronisasi stok terpusat...");
            
            const stokBaru = barang.map(item => {
                let stokAkhir = item.stok;
                
                transaksiPemasukan.forEach(transaksi => {
                    transaksi.barang.forEach(barangTransaksi => {
                        if (barangTransaksi.kodeBarang === item.kode) {
                            stokAkhir += barangTransaksi.jumlah || 0;
                        }
                    });
                });
                
                transaksiPengeluaran.forEach(transaksi => {
                    transaksi.barang.forEach(barangTransaksi => {
                        if (barangTransaksi.kodeBarang === item.kode) {
                            stokAkhir -= barangTransaksi.jumlahKeluar || 0;
                        }
                    });
                });
                
                return { ...item, stok: Math.max(0, stokAkhir) };
            });
            
            this.saveDataBarang(stokBaru);
            console.log("Sinkronisasi stok selesai:", stokBaru);
            return stokBaru;
        }
    };

    // ===== Laporan =====
    function tampilkanLaporan() {
        const transaksiPemasukan = JSON.parse(localStorage.getItem(DATA_CONFIG.STORAGE_KEYS.TRANSAKSI_PEMASUKAN)) || [];
        const transaksiPengeluaran = JSON.parse(localStorage.getItem(DATA_CONFIG.STORAGE_KEYS.TRANSAKSI_PENGELUARAN)) || [];
        
        const semuaTransaksi = [
            ...transaksiPemasukan.map(t => ({ ...t, jenis: 'Pemasukan' })),
            ...transaksiPengeluaran.map(t => ({ ...t, jenis: 'Pengeluaran' }))
        ];

        const tbody = document.querySelector("#tabelLaporan tbody");
        tbody.innerHTML = "";

        semuaTransaksi.forEach(transaksi => {
            transaksi.barang.forEach(barang => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${transaksi.tanggal}</td>
                    <td>${transaksi.jenis}</td>
                    <td>${barang.kodeBarang}</td>
                    <td>${barang.namaBarang}</td>
                    <td>${barang.jumlah || barang.jumlahKeluar || 0}</td>
                    <td>${barang.satuan || '-'}</td>
                    <td>${barang.lokasi || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        });

        updateRingkasan(semuaTransaksi);
    }

    function updateRingkasan(transaksi) {
        const totalTransaksi = transaksi.length;
        let totalPemasukan = 0;
        let totalPengeluaran = 0;

        transaksi.forEach(t => {
            if (t.barang && Array.isArray(t.barang)) {
                if (t.jenis === 'Pemasukan') {
                    totalPemasukan += t.barang.reduce(
                        (sum, b) => sum + (parseInt(b.jumlah) || 0),
                        0
                    );
                } else if (t.jenis === 'Pengeluaran') {
                    totalPengeluaran += t.barang.reduce(
                        (sum, b) => sum + (parseInt(b.jumlahKeluar) || 0),
                        0
                    );
                }
            }
        });

        document.getElementById('totalTransaksi').textContent = totalTransaksi;
        document.getElementById('totalPemasukan').textContent = totalPemasukan;
        document.getElementById('totalPengeluaran').textContent = totalPengeluaran;
    }

    document.addEventListener("DOMContentLoaded", function() {
        DATA_CONFIG.initData();
        DATA_CONFIG.sinkronisasiStok();
        tampilkanLaporan();
    });
    </script>
</body>
</html>
