<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Transaksi</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        h1 {
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 8px;
            text-align: center;
        }
        button {
            padding: 5px 10px;
            border: none;
            background: #007bff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .link-transaksi {
            color: blue;
            text-decoration: underline;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Laporan Transaksi</h1>

    <table>
        <thead>
            <tr>
                <th>No</th>
                <th>No. Transaksi</th>
                <th>Tanggal</th>
                <th>Jenis</th>
                <th>Supplier/Tujuan</th>
                <th>Total Item</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody id="tbodyLaporan"></tbody>
    </table>

    <script>
        // Ambil data dari localStorage
        function ambilData() {
            const pemasukan = JSON.parse(localStorage.getItem('transaksiPemasukan')) || [];
            const pengeluaran = JSON.parse(localStorage.getItem('transaksiPengeluaran')) || [];

            return [
                ...pemasukan.map(t => ({ ...t, jenis: "Pemasukan" })),
                ...pengeluaran.map(t => ({ ...t, jenis: "Pengeluaran" }))
            ];
        }

        // Tampilkan data ke tabel
        function tampilkanData(transaksi) {
            const tbody = document.getElementById("tbodyLaporan");
            tbody.innerHTML = "";

            transaksi.forEach((t, i) => {
                const totalItem = (t.barang || []).reduce((sum, b) => {
                    return sum + (parseInt(b.jumlah || b.jumlahMasuk || b.jumlahKeluar || 0));
                }, 0);

                const noTrans = t.noTransaksi || t.noTransaksiKeluar || t.idTransaksi || t.kodeTransaksi || "-";
                const tanggal = t.tanggalMasuk || t.tanggalKeluar || "-";
                const tujuan = t.supplier || t.tujuan || "-";

                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${i + 1}</td>
                    <td><span class="link-transaksi" onclick="lihatDetail('${noTrans}', '${t.jenis}')">${noTrans}</span></td>
                    <td>${tanggal}</td>
                    <td>${t.jenis}</td>
                    <td>${tujuan}</td>
                    <td>${totalItem}</td>
                    <td><button onclick="lihatDetail('${noTrans}', '${t.jenis}')">Detail</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Tampilkan detail transaksi
        function lihatDetail(noTransaksi, jenis) {
            const pemasukan = JSON.parse(localStorage.getItem('transaksiPemasukan')) || [];
            const pengeluaran = JSON.parse(localStorage.getItem('transaksiPengeluaran')) || [];
            let transaksi;

            if (jenis === "Pemasukan") {
                transaksi = pemasukan.find(t =>
                    t.noTransaksi === noTransaksi ||
                    t.idTransaksi === noTransaksi ||
                    t.kodeTransaksi === noTransaksi
                );
            } else {
                transaksi = pengeluaran.find(t =>
                    t.noTransaksiKeluar === noTransaksi ||
                    t.idTransaksi === noTransaksi ||
                    t.kodeTransaksi === noTransaksi
                );
            }

            if (!transaksi) {
                alert("Transaksi tidak ditemukan!");
                return;
            }

            let detail = `ðŸ“‹ Detail Transaksi ${jenis}\n\n`;
            detail += `No. Transaksi : ${noTransaksi}\n`;
            detail += `Tanggal       : ${transaksi.tanggalMasuk || transaksi.tanggalKeluar || "-"}\n`;
            detail += `${jenis === "Pemasukan" ? "Supplier" : "Tujuan"} : ${transaksi.supplier || transaksi.tujuan || "-"}\n`;
            detail += `Keterangan    : ${transaksi.keterangan || transaksi.keteranganKeluar || "-"}\n\n`;

            detail += "ðŸ“¦ Daftar Barang:\n";
            if (transaksi.barang && transaksi.barang.length > 0) {
                transaksi.barang.forEach((b, idx) => {
                    detail += `${idx + 1}. Kode: ${b.kodeBarang || "-"}, Nama: ${b.namaBarang || b.nama || "-"}, Jumlah: ${b.jumlah || b.jumlahMasuk || b.jumlahKeluar || 0}\n`;
                });
            } else {
                detail += "- Tidak ada barang -\n";
            }

            alert(detail);
        }

        // Saat halaman dibuka
        window.onload = () => {
            const data = ambilData();
            tampilkanData(data);
        };
    </script>
</body>
</html>
