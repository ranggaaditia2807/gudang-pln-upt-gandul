<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Transaksi</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>Laporan Transaksi</h1>

    <table border="1">
        <thead>
            <tr>
                <th>No</th>
                <th>No. Transaksi</th>
                <th>Tanggal</th>
                <th>Jenis</th>
                <th>Supplier/Tujuan</th>
                <th>Total Item</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody id="tbodyLaporan"></tbody>
    </table>

    <script>
        function ambilData() {
            const transaksiPemasukan = JSON.parse(localStorage.getItem('transaksiPemasukan')) || [];
            const transaksiPengeluaran = JSON.parse(localStorage.getItem('transaksiPengeluaran')) || [];
            
            const dataGabungan = [
                ...transaksiPemasukan.map(t => ({ ...t, jenis: 'Pemasukan' })),
                ...transaksiPengeluaran.map(t => ({ ...t, jenis: 'Pengeluaran' }))
            ];
            
            return dataGabungan;
        }

        function tampilkanData(transaksi) {
            const tbody = document.getElementById('tbodyLaporan');
            tbody.innerHTML = '';
            
            transaksi.forEach((t, index) => {
                let totalItem = 0;
                if (t.barang && Array.isArray(t.barang)) {
                    totalItem = t.barang.reduce((sum, b) => {
                        return sum + (
                            parseInt(b.jumlah || b.jumlahMasuk || b.jumlahKeluar || 0)
                        );
                    }, 0);
                }

                const noTrans = t.noTransaksi || t.noTransaksiKeluar || t.idTransaksi || t.kodeTransaksi || '-';
                const tanggal = t.tanggalMasuk || t.tanggalKeluar || '-';
                const tujuan = t.supplier || t.tujuan || '-';

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${noTrans}</td>
                    <td>${tanggal}</td>
                    <td>${t.jenis}</td>
                    <td>${tujuan}</td>
                    <td>${totalItem}</td>
                    <td>
                        <button onclick="lihatDetail('${noTrans}', '${t.jenis}')">Detail</button>
                    </td>
                `;
            });
        }

        function lihatDetail(noTransaksi, jenis) {
            const transaksiPemasukan = JSON.parse(localStorage.getItem('transaksiPemasukan')) || [];
            const transaksiPengeluaran = JSON.parse(localStorage.getItem('transaksiPengeluaran')) || [];
            
            let transaksi;
            if (jenis === 'Pemasukan') {
                transaksi = transaksiPemasukan.find(t => 
                    t.noTransaksi === noTransaksi || 
                    t.idTransaksi === noTransaksi || 
                    t.kodeTransaksi === noTransaksi
                );
            } else {
                transaksi = transaksiPengeluaran.find(t => 
                    t.noTransaksiKeluar === noTransaksi || 
                    t.idTransaksi === noTransaksi || 
                    t.kodeTransaksi === noTransaksi
                );
            }
            
            if (transaksi) {
                let detail = `Detail Transaksi ${jenis}\n\n`;
                detail += `No. Transaksi: ${noTransaksi}\n`;
                detail += `Tanggal: ${transaksi.tanggalMasuk || transaksi.tanggalKeluar || '-'}\n`;
                detail += `${jenis === 'Pemasukan' ? 'Supplier' : 'Tujuan'}: ${transaksi.supplier || transaksi.tujuan || '-'}\n`;
                detail += `Keterangan: ${transaksi.keterangan || transaksi.keteranganKeluar || '-'}\n\n`;
                detail += 'Detail Barang:\n';
                
                if (transaksi.barang && Array.isArray(transaksi.barang) && transaksi.barang.length > 0) {
                    transaksi.barang.forEach((b, i) => {
                        detail += `${i + 1}. Kode: ${b.kodeBarang || '-'}, Nama: ${b.namaBarang || b.nama || '-'}, Jumlah: ${b.jumlah || b.jumlahMasuk || b.jumlahKeluar || 0}\n`;
                    });
                } else {
                    detail += 'Tidak ada detail barang.\n';
                }

                alert(detail);
            } else {
                console.warn("Transaksi tidak ditemukan:", noTransaksi, jenis);
                alert('Transaksi tidak ditemukan. Silakan cek console (F12).');
            }
        }

        window.onload = function() {
            const data = ambilData();
            tampilkanData(data);
        };
    </script>
</body>
</html>
