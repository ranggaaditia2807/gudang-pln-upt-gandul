<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Transaksi</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>Laporan Transaksi</h1>

    <div class="filter">
        <label for="filterJenis">Jenis:</label>
        <select id="filterJenis">
            <option value="all">Semua</option>
            <option value="Pemasukan">Pemasukan</option>
            <option value="Pengeluaran">Pengeluaran</option>
        </select>
        <button onclick="filterData()">Terapkan</button>
    </div>

    <table border="1">
        <thead>
            <tr>
                <th>No</th>
                <th>No. Transaksi</th>
                <th>Tanggal</th>
                <th>Jenis</th>
                <th>Supplier/Tujuan</th>
                <th>Total Item</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody id="tbodyLaporan"></tbody>
    </table>

    <h2>Ringkasan</h2>
    <p>Total Pemasukan: <span id="totalPemasukan">0</span></p>
    <p>Total Pengeluaran: <span id="totalPengeluaran">0</span></p>

    <script>
        function ambilData() {
            const transaksiPemasukan = JSON.parse(localStorage.getItem('transaksiPemasukan')) || [];
            const transaksiPengeluaran = JSON.parse(localStorage.getItem('transaksiPengeluaran')) || [];
            
            const dataGabungan = [
                ...transaksiPemasukan.map(t => ({ ...t, jenis: 'Pemasukan' })),
                ...transaksiPengeluaran.map(t => ({ ...t, jenis: 'Pengeluaran' }))
            ];
            
            return dataGabungan;
        }

        function tampilkanData(transaksi) {
            const tbody = document.getElementById('tbodyLaporan');
            tbody.innerHTML = '';
            
            transaksi.forEach((t, index) => {
                const row = tbody.insertRow();
                
                // hitung total item
                let totalItem = 0;
                if (t.barang && Array.isArray(t.barang)) {
                    totalItem = t.barang.reduce((sum, b) => {
                        return sum + (
                            parseInt(b.jumlah || b.jumlahMasuk || b.jumlahKeluar || 0)
                        );
                    }, 0);
                }

                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${t.noTransaksi || t.noTransaksiKeluar || t.idTransaksi || '-'}</td>
                    <td>${t.tanggalMasuk || t.tanggalKeluar || '-'}</td>
                    <td><span class="${t.jenis === 'Pemasukan' ? 'status-masuk' : 'status-keluar'}">${t.jenis}</span></td>
                    <td>${t.supplier || t.tujuan || '-'}</td>
                    <td>${totalItem}</td>
                    <td>
                        <button onclick="lihatDetail('${t.noTransaksi || t.noTransaksiKeluar || t.idTransaksi}', '${t.jenis}')">Detail</button>
                    </td>
                `;
            });
        }

        function lihatDetail(noTransaksi, jenis) {
            const transaksiPemasukan = JSON.parse(localStorage.getItem('transaksiPemasukan')) || [];
            const transaksiPengeluaran = JSON.parse(localStorage.getItem('transaksiPengeluaran')) || [];
            
            let transaksi;
            if (jenis === 'Pemasukan') {
                transaksi = transaksiPemasukan.find(t => 
                    t.noTransaksi === noTransaksi || 
                    t.idTransaksi === noTransaksi || 
                    t.kodeTransaksi === noTransaksi
                );
            } else {
                transaksi = transaksiPengeluaran.find(t => 
                    t.noTransaksiKeluar === noTransaksi || 
                    t.idTransaksi === noTransaksi || 
                    t.kodeTransaksi === noTransaksi
                );
            }
            
            if (transaksi) {
                let detail = `Detail Transaksi ${jenis}\n\n`;
                detail += `No. Transaksi: ${transaksi.noTransaksi || transaksi.noTransaksiKeluar || transaksi.idTransaksi || transaksi.kodeTransaksi || '-'}\n`;
                detail += `Tanggal: ${transaksi.tanggalMasuk || transaksi.tanggalKeluar || '-'}\n`;
                detail += `${jenis === 'Pemasukan' ? 'Supplier' : 'Tujuan'}: ${transaksi.supplier || transaksi.tujuan || '-'}\n`;
                detail += `Keterangan: ${transaksi.keterangan || transaksi.keteranganKeluar || '-'}\n\n`;
                detail += 'Detail Barang:\n';
                
                if (transaksi.barang && Array.isArray(transaksi.barang) && transaksi.barang.length > 0) {
                    transaksi.barang.forEach((b, i) => {
                        detail += `${i + 1}. Kode: ${b.kodeBarang || '-'}, Nama: ${b.namaBarang || b.nama || '-'}, Jumlah: ${b.jumlah || b.jumlahMasuk || b.jumlahKeluar || 0}\n`;
                    });
                } else {
                    detail += 'Tidak ada detail barang.\n';
                }

                alert(detail);
            } else {
                console.warn("Data di localStorage:", {transaksiPemasukan, transaksiPengeluaran});
                alert('Transaksi tidak ditemukan. Cek console (F12) untuk melihat data di localStorage.');
            }
        }

        function updateRingkasan() {
            const data = ambilData();
            const totalPemasukan = data.filter(t => t.jenis === 'Pemasukan').length;
            const totalPengeluaran = data.filter(t => t.jenis === 'Pengeluaran').length;
            
            document.getElementById('totalPemasukan').textContent = totalPemasukan;
            document.getElementById('totalPengeluaran').textContent = totalPengeluaran;
        }

        function filterData() {
            const jenis = document.getElementById('filterJenis').value;
            let data = ambilData();
            
            if (jenis !== 'all') {
                data = data.filter(t => t.jenis === jenis);
            }
            
            tampilkanData(data);
        }

        window.onload = function() {
            const data = ambilData();
            tampilkanData(data);
            updateRingkasan();
        };
    </script>
</body>
</html>
